{% extends "base/base_dashboard.html" %}
{% load crispy_forms_tags %}

{% block title %}{{ product.name }}{% endblock %}

{% block content %}
<div class="container mx-auto">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Ürün Detayı</h1>
    <div class="text-sm breadcrumbs">
      <ul>
        <li><a href="{% url 'dashboard:dashboard' %}">VivaCRM</a></li>
        <li><a href="{% url 'products:product-list' %}">Ürünler</a></li>
        <li>{{ product.name }}</li>
      </ul>
    </div>
  </div>
  
  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <div class="flex justify-between items-start">
        <div>
          <h2 class="card-title text-2xl">
            {{ product.name }}
            <div class="badge badge-primary ml-2">{{ product.code }}</div>
            {% if product.status == 'available' %}
            <div class="badge badge-success">{{ product.get_status_display }}</div>
            {% elif product.status == 'unavailable' %}
            <div class="badge badge-error">{{ product.get_status_display }}</div>
            {% elif product.status == 'coming_soon' %}
            <div class="badge badge-warning">{{ product.get_status_display }}</div>
            {% else %}
            <div class="badge badge-ghost">{{ product.get_status_display }}</div>
            {% endif %}
          </h2>
          <p class="text-lg">{{ product.category|default:"Kategorisiz" }}</p>
        </div>
        
        <div class="flex space-x-2">
          <a href="{% url 'products:product-update' slug=product.slug %}" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
            Düzenle
          </a>
          <a href="{% url 'products:product-delete' slug=product.slug %}" class="btn btn-error btn-outline">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Sil
          </a>
        </div>
      </div>
      
      <div class="divider"></div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Product Images -->
        <div class="col-span-1">
          <h3 class="text-lg font-semibold mb-3">Ürün Görselleri</h3>
          
          <div class="grid grid-cols-2 gap-2">
            {% for image in product.images.all %}
            <div class="relative">
              <img src="{{ image.image.url }}" alt="{{ image.alt_text }}" class="w-full h-32 object-cover rounded-lg">
              {% if image.is_primary %}
              <div class="absolute top-2 right-2 badge badge-primary">Ana Görsel</div>
              {% endif %}
              <button class="absolute bottom-2 right-2 btn btn-xs btn-error btn-circle" onclick="deleteImage({{ image.id }})">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            {% empty %}
            <div class="col-span-2 bg-base-200 h-32 rounded-lg flex items-center justify-center">
              <p class="text-center text-base-content/60">Görsel bulunmamaktadır</p>
            </div>
            {% endfor %}
          </div>
          
          <div class="mt-3">
            <button class="btn btn-outline btn-primary btn-sm w-full" onclick="document.getElementById('image-modal').showModal()">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              Görsel Ekle
            </button>
          </div>
        </div>
        
        <!-- Product Details -->
        <div class="col-span-2">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Pricing -->
            <div>
              <h3 class="text-lg font-semibold mb-3">Fiyat Bilgileri</h3>
              <div class="overflow-x-auto">
                <table class="table">
                  <tbody>
                    <tr>
                      <td class="font-bold">Satış Fiyatı</td>
                      <td>{{ product.price }} ₺</td>
                    </tr>
                    {% if product.discount_price %}
                    <tr>
                      <td class="font-bold">İndirimli Fiyat</td>
                      <td>{{ product.discount_price }} ₺</td>
                    </tr>
                    {% endif %}
                    <tr>
                      <td class="font-bold">KDV Oranı</td>
                      <td>%{{ product.tax_rate }}</td>
                    </tr>
                    <tr>
                      <td class="font-bold">KDV Tutarı</td>
                      <td>{{ product.tax_amount }} ₺</td>
                    </tr>
                    <tr>
                      <td class="font-bold">Toplam Fiyat</td>
                      <td class="font-semibold">{{ product.price_with_tax }} ₺</td>
                    </tr>
                    {% if product.cost %}
                    <tr>
                      <td class="font-bold">Maliyet</td>
                      <td>{{ product.cost }} ₺</td>
                    </tr>
                    {% if product.profit_margin %}
                    <tr>
                      <td class="font-bold">Kar Marjı</td>
                      <td>%{{ product.profit_margin }}</td>
                    </tr>
                    {% endif %}
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Inventory -->
            <div>
              <div class="flex justify-between items-center mb-3">
                <h3 class="text-lg font-semibold">Stok Bilgileri</h3>
                <a href="{% url 'products:movement-create' %}?product={{ product.id }}" class="btn btn-outline btn-primary btn-sm">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                  </svg>
                  Stok Hareketi
                </a>
              </div>
              <div class="overflow-x-auto">
                <table class="table">
                  <tbody>
                    <tr>
                      <td class="font-bold">Stok Miktarı</td>
                      <td>
                        <div class="flex items-center">
                          {{ product.stock }}
                          {% if product.is_physical and product.stock <= 10 and product.stock > 0 %}
                            <span class="badge badge-warning ml-2">Düşük Stok</span>
                          {% endif %}
                          {% if product.is_physical and product.stock == 0 %}
                            <span class="badge badge-error ml-2">Stokta Yok</span>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                    <tr>
                      <td class="font-bold">Ürün Tipi</td>
                      <td>{% if product.is_physical %}Fiziksel Ürün{% else %}Dijital Ürün / Hizmet{% endif %}</td>
                    </tr>
                    {% if product.is_physical %}
                    <tr>
                      <td class="font-bold">Ağırlık</td>
                      <td>{{ product.weight|default:"-" }} kg</td>
                    </tr>
                    <tr>
                      <td class="font-bold">Boyutlar</td>
                      <td>{{ product.dimensions|default:"-" }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                      <td class="font-bold">SKU</td>
                      <td>{{ product.sku|default:"-" }}</td>
                    </tr>
                    <tr>
                      <td class="font-bold">Barkod</td>
                      <td>{{ product.barcode|default:"-" }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          {% if product.description %}
          <div class="mt-6">
            <h3 class="text-lg font-semibold mb-3">Ürün Açıklaması</h3>
            <div class="p-4 bg-base-200 rounded-lg">
              {{ product.description|linebreaks }}
            </div>
          </div>
          {% endif %}
          
          <!-- Product Attributes -->
          <div class="mt-6">
            <div class="flex justify-between items-center mb-3">
              <h3 class="text-lg font-semibold">Ürün Özellikleri</h3>
              <button class="btn btn-outline btn-primary btn-sm" onclick="document.getElementById('attribute-modal').showModal()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Özellik Ekle
              </button>
            </div>
            
            {% if product.attribute_values.exists %}
            <div class="overflow-x-auto">
              <table class="table table-zebra w-full">
                <thead>
                  <tr>
                    <th>Özellik</th>
                    <th>Değer</th>
                    <th>İşlemler</th>
                  </tr>
                </thead>
                <tbody>
                  {% for attr_value in product.attribute_values.all %}
                  <tr>
                    <td>{{ attr_value.attribute.name }}</td>
                    <td>{{ attr_value.value }}</td>
                    <td class="flex space-x-1">
                      <button class="btn btn-square btn-sm btn-ghost" onclick="editAttributeValue({{ attr_value.id }})">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                      </button>
                      <button class="btn btn-square btn-sm btn-ghost" onclick="deleteAttributeValue({{ attr_value.id }})">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="alert alert-info">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              <span>Henüz ürün özelliği eklenmemiştir.</span>
            </div>
            {% endif %}
          </div>
          
          <!-- System Info -->
          <div class="mt-6">
            <h3 class="text-lg font-semibold mb-3">Sistem Bilgileri</h3>
            <div class="overflow-x-auto">
              <table class="table">
                <tbody>
                  <tr>
                    <td class="font-bold">Oluşturulma Tarihi</td>
                    <td>{{ product.created_at|date:"d.m.Y H:i" }}</td>
                  </tr>
                  <tr>
                    <td class="font-bold">Son Güncelleme</td>
                    <td>{{ product.updated_at|date:"d.m.Y H:i" }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Stock Movements Card -->
  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <div class="flex justify-between items-start">
        <h2 class="card-title">Stok Hareketleri</h2>
        <a href="{% url 'products:movement-list' %}?product={{ product.id }}" class="btn btn-link">Tümünü Görüntüle</a>
      </div>
      
      <div class="overflow-x-auto">
        <table class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Hareket Tipi</th>
              <th class="text-right">Miktar</th>
              <th>Önceki Stok</th>
              <th>Yeni Stok</th>
              <th>Tarih</th>
              <th>Oluşturan</th>
            </tr>
          </thead>
          <tbody>
            {% for movement in stock_movements %}
              <tr>
                <td>
                  {% if movement.movement_type == 'purchase' %}
                    <span class="badge badge-info">{{ movement.get_movement_type_display }}</span>
                  {% elif movement.movement_type == 'sale' %}
                    <span class="badge badge-warning">{{ movement.get_movement_type_display }}</span>
                  {% elif movement.movement_type == 'return' %}
                    <span class="badge badge-success">{{ movement.get_movement_type_display }}</span>
                  {% elif movement.movement_type == 'adjustment' %}
                    <span class="badge badge-primary">{{ movement.get_movement_type_display }}</span>
                  {% elif movement.movement_type == 'inventory' %}
                    <span class="badge badge-secondary">{{ movement.get_movement_type_display }}</span>
                  {% elif movement.movement_type == 'waste' %}
                    <span class="badge badge-error">{{ movement.get_movement_type_display }}</span>
                  {% else %}
                    <span class="badge">{{ movement.get_movement_type_display }}</span>
                  {% endif %}
                </td>
                <td class="text-right">
                  {% if movement.movement_type in 'purchase,return,adjustment,inventory' %}
                    <span class="text-success">+{{ movement.quantity }}</span>
                  {% else %}
                    <span class="text-error">-{{ movement.quantity }}</span>
                  {% endif %}
                </td>
                <td>{{ movement.previous_stock }}</td>
                <td>{{ movement.new_stock }}</td>
                <td>{{ movement.created_at|date:"d.m.Y H:i" }}</td>
                <td>{{ movement.created_by }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="text-center py-4">
                  <div class="alert alert-info mb-0">
                    Henüz stok hareketi bulunmamaktadır.
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <div class="mt-4">
        <a href="{% url 'products:movement-create' %}?product={{ product.id }}" class="btn btn-primary">
          <i class="fas fa-plus-circle mr-2"></i>Yeni Stok Hareketi
        </a>
      </div>
    </div>
  </div>
  
  <!-- Image Modal -->
  <dialog id="image-modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">Ürün Görseli Ekle</h3>
      <form method="post" action="{% url 'products:product-image-create' slug=product.slug %}" enctype="multipart/form-data" class="space-y-4">
        {% csrf_token %}
        {{ image_form|crispy }}
        <div class="modal-action">
          <button type="button" class="btn btn-ghost" onclick="document.getElementById('image-modal').close()">İptal</button>
          <button type="submit" class="btn btn-primary">Kaydet</button>
        </div>
      </form>
    </div>
  </dialog>
  
  <!-- Attribute Modal -->
  <dialog id="attribute-modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">Ürün Özelliği Ekle</h3>
      <form method="post" action="{% url 'products:attribute-value-create' slug=product.slug %}" class="space-y-4">
        {% csrf_token %}
        {{ attribute_value_form|crispy }}
        <div class="modal-action">
          <button type="button" class="btn btn-ghost" onclick="document.getElementById('attribute-modal').close()">İptal</button>
          <button type="submit" class="btn btn-primary">Kaydet</button>
        </div>
      </form>
    </div>
  </dialog>
  
  <!-- Stock Movement Modal -->
  <dialog id="stock-movement-modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">Stok Hareketi Ekle</h3>
      <form method="post" action="{% url 'products:movement-create' %}" class="space-y-4">
        {% csrf_token %}
        {{ stock_movement_form|crispy }}
        <div class="modal-action">
          <button type="button" class="btn btn-ghost" onclick="document.getElementById('stock-movement-modal').close()">İptal</button>
          <button type="submit" class="btn btn-primary">Kaydet</button>
        </div>
      </form>
    </div>
  </dialog>
</div>

<script>
  // Image functions
  function deleteImage(imageId) {
    if (confirm('Bu görseli silmek istediğinizden emin misiniz?')) {
      fetch(`/products/images/${imageId}/delete/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.reload();
        } else {
          alert('Görsel silinirken bir hata oluştu.');
        }
      });
    }
  }
  
  // Attribute value functions
  function editAttributeValue(valueId) {
    window.location.href = `/products/attribute-values/${valueId}/edit/`;
  }
  
  function deleteAttributeValue(valueId) {
    if (confirm('Bu özellik değerini silmek istediğinizden emin misiniz?')) {
      fetch(`/products/attribute-values/${valueId}/delete/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.reload();
        } else {
          alert('Özellik değeri silinirken bir hata oluştu.');
        }
      });
    }
  }
</script>
{% endblock %}