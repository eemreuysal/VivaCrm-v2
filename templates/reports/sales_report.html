{% extends "base/base_dashboard.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block title %}Satış Raporu{% endblock %}

{% block content %}
<div>
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Satış Raporu</h1>
    <div class="text-sm breadcrumbs">
      <ul>
        <li><a href="{% url 'dashboard:dashboard' %}">VivaCRM</a></li>
        <li><a href="{% url 'reports:dashboard' %}">Raporlar</a></li>
        <li>Satış Raporu</li>
      </ul>
    </div>
  </div>
  
  <!-- Report Parameters -->
  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title mb-4">Rapor Parametreleri</h2>
      
      <form method="get" hx-boost="true">
        {% crispy form %}
      </form>
    </div>
  </div>
  
  {% if sales_summary %}
  <!-- Save Report -->
  <div class="flex justify-end mb-6">
    <button class="btn btn-primary" onclick="document.getElementById('save-report-modal').showModal()">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
      </svg>
      Raporu Kaydet
    </button>
  </div>
  
  <!-- Sales Summary -->
  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title mb-4">Satış Özeti</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="stats shadow">
          <div class="stat">
            <div class="stat-title">Sipariş Sayısı</div>
            <div class="stat-value">{{ sales_summary.order_count }}</div>
            <div class="stat-desc">
              {% if sales_summary.order_count > 0 %}
              {{ sales_summary.completed_orders }} tamamlandı ({{ sales_summary.completion_rate|floatformat:1 }}%)
              {% endif %}
            </div>
          </div>
        </div>
        
        <div class="stats shadow">
          <div class="stat">
            <div class="stat-title">Toplam Gelir</div>
            <div class="stat-value">{{ sales_summary.total_revenue }} ₺</div>
            <div class="stat-desc">
              {% if sales_summary.order_count > 0 %}
              Ortalama: {{ sales_summary.avg_order_value|floatformat:2 }} ₺ / sipariş
              {% endif %}
            </div>
          </div>
        </div>
        
        <div class="stats shadow">
          <div class="stat">
            <div class="stat-title">Sipariş Dağılımı</div>
            <div class="stat-value flex items-center">
              <span class="text-success text-xl mr-2">{{ sales_summary.completed_orders }}</span>
              <span class="text-error text-xl">{{ sales_summary.cancelled_orders }}</span>
            </div>
            <div class="stat-desc">Tamamlanan / İptal Edilen</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Sales Chart -->
  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title mb-4">Satış Grafiği</h2>
      
      <div class="w-full h-80">
        <canvas id="salesChart"></canvas>
      </div>
    </div>
  </div>
  
  <!-- Products and Payment Methods -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <!-- Top Products -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title mb-4">En Çok Satan Ürünler</h2>
        
        {% if top_products %}
        <div class="overflow-x-auto">
          <table class="table table-zebra w-full">
            <thead>
              <tr>
                <th>Ürün</th>
                <th class="text-right">Satış Adedi</th>
                <th class="text-right">Gelir</th>
              </tr>
            </thead>
            <tbody>
              {% for product in top_products %}
              <tr>
                <td>
                  <div class="font-bold">{{ product.product__name }}</div>
                  <div class="text-sm opacity-70">{{ product.product__code }}</div>
                </td>
                <td class="text-right">{{ product.quantity_sold }}</td>
                <td class="text-right">{{ product.total_revenue }} ₺</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          <span>Bu dönemde ürün satışı bulunmamaktadır.</span>
        </div>
        {% endif %}
      </div>
    </div>
    
    <!-- Payment Methods -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title mb-4">Ödeme Yöntemleri</h2>
        
        {% if payment_stats %}
        <div class="overflow-x-auto">
          <table class="table table-zebra w-full">
            <thead>
              <tr>
                <th>Ödeme Yöntemi</th>
                <th class="text-right">İşlem</th>
                <th class="text-right">Tutar</th>
                <th class="text-right">Oran</th>
              </tr>
            </thead>
            <tbody>
              {% for stat in payment_stats %}
              <tr>
                <td>
                  {% if stat.payment_method == 'credit_card' %}
                    Kredi Kartı
                  {% elif stat.payment_method == 'bank_transfer' %}
                    Banka Havalesi
                  {% elif stat.payment_method == 'cash' %}
                    Nakit
                  {% elif stat.payment_method == 'online_payment' %}
                    Online Ödeme
                  {% else %}
                    Diğer
                  {% endif %}
                </td>
                <td class="text-right">{{ stat.count }}</td>
                <td class="text-right">{{ stat.total_amount }} ₺</td>
                <td class="text-right">{{ stat.percentage|floatformat:1 }}%</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          <span>Bu dönemde ödeme verisi bulunmamaktadır.</span>
        </div>
        {% endif %}
        
        {% if payment_stats %}
        <div class="w-full h-64 mt-4">
          <canvas id="paymentChart"></canvas>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Sales Data Table -->
  <div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
      <h2 class="card-title mb-4">Detaylı Satış Verileri</h2>
      
      {% if sales_by_period %}
      <div class="overflow-x-auto">
        <table class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Dönem</th>
              <th class="text-right">Sipariş Sayısı</th>
              <th class="text-right">Toplam Gelir</th>
              <th class="text-right">Ortalama Sipariş</th>
            </tr>
          </thead>
          <tbody>
            {% for period_data in sales_by_period %}
            <tr>
              <td>{{ period_data.period|date:"d.m.Y" }}</td>
              <td class="text-right">{{ period_data.order_count }}</td>
              <td class="text-right">{{ period_data.total_revenue }} ₺</td>
              <td class="text-right">{{ period_data.avg_order_value|floatformat:2 }} ₺</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-info">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span>Bu dönemde satış verisi bulunmamaktadır.</span>
      </div>
      {% endif %}
    </div>
  </div>
  
  <!-- Save Report Modal -->
  <dialog id="save-report-modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">Raporu Kaydet</h3>
      <form method="post" action="{% url 'reports:save-report' %}" class="space-y-4">
        {% csrf_token %}
        {{ save_form|crispy }}
        <input type="hidden" name="parameters" value='{{ report_parameters|safe }}'>
        <div class="modal-action">
          <button type="button" class="btn btn-ghost" onclick="document.getElementById('save-report-modal').close()">İptal</button>
          <button type="submit" class="btn btn-primary">Kaydet</button>
        </div>
      </form>
    </div>
  </dialog>
  {% endif %}
</div>

{% if sales_by_period %}
<script>
  // Sales Chart
  const salesCtx = document.getElementById('salesChart').getContext('2d');
  const salesChart = new Chart(salesCtx, {
    type: 'line',
    data: {
      labels: [
        {% for period_data in sales_by_period %}
          "{{ period_data.period|date:"d.m.Y" }}",
        {% endfor %}
      ],
      datasets: [{
        label: 'Gelir (₺)',
        data: [
          {% for period_data in sales_by_period %}
            {{ period_data.total_revenue }},
          {% endfor %}
        ],
        backgroundColor: 'rgba(79, 70, 229, 0.2)',
        borderColor: 'rgba(79, 70, 229, 1)',
        borderWidth: 2,
        pointBackgroundColor: 'rgba(79, 70, 229, 1)',
        pointRadius: 4,
        tension: 0.3
      }, {
        label: 'Sipariş Sayısı',
        data: [
          {% for period_data in sales_by_period %}
            {{ period_data.order_count }},
          {% endfor %}
        ],
        backgroundColor: 'rgba(59, 130, 246, 0.2)',
        borderColor: 'rgba(59, 130, 246, 1)',
        borderWidth: 2,
        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
        pointRadius: 4,
        tension: 0.3,
        yAxisID: 'y1'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Gelir (₺)'
          }
        },
        y1: {
          beginAtZero: true,
          position: 'right',
          grid: {
            drawOnChartArea: false
          },
          title: {
            display: true,
            text: 'Sipariş Sayısı'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Tarih'
          }
        }
      }
    }
  });
</script>
{% endif %}

{% if payment_stats %}
<script>
  // Payment Methods Chart
  const paymentCtx = document.getElementById('paymentChart').getContext('2d');
  const paymentChart = new Chart(paymentCtx, {
    type: 'pie',
    data: {
      labels: [
        {% for stat in payment_stats %}
          {% if stat.payment_method == 'credit_card' %}
            "Kredi Kartı",
          {% elif stat.payment_method == 'bank_transfer' %}
            "Banka Havalesi",
          {% elif stat.payment_method == 'cash' %}
            "Nakit",
          {% elif stat.payment_method == 'online_payment' %}
            "Online Ödeme",
          {% else %}
            "Diğer",
          {% endif %}
        {% endfor %}
      ],
      datasets: [{
        data: [
          {% for stat in payment_stats %}
            {{ stat.total_amount }},
          {% endfor %}
        ],
        backgroundColor: [
          'rgba(79, 70, 229, 0.8)',
          'rgba(59, 130, 246, 0.8)',
          'rgba(16, 185, 129, 0.8)',
          'rgba(245, 158, 11, 0.8)',
          'rgba(239, 68, 68, 0.8)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const value = context.raw;
              const percentage = ((value / total) * 100).toFixed(1);
              return `${context.label}: ${value} ₺ (${percentage}%)`;
            }
          }
        }
      }
    }
  });
</script>
{% endif %}
{% endblock %}