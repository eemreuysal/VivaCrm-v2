/**
 * VivaCRM Global Components
 * 
 * Bu dosya, t√ºm sayfalarda kullanƒ±lan global Alpine.js bile≈üenlerini ve
 * yardƒ±mcƒ± fonksiyonlarƒ± tanƒ±mlar. Sayfa y√ºklenmeden √∂nce dahil edilmelidir.
 */

// Global bile≈üenleri tanƒ±mla - Window objesine baƒüla
(function() {
  // Hata ayƒ±klama loglama fonksiyonu
  window.vivaLog = function(message, type = 'info') {
    const prefix = 'üåç Global: ';
    switch(type) {
      case 'error':
        console.error(prefix + message);
        break;
      case 'warn':
        console.warn(prefix + message);
        break;
      default:
        console.log(prefix + message);
    }
  };

  // Tema Store - Alpine.store('theme') i√ßin global tanƒ±m
  // Merkezi ThemeManager'a baƒülanƒ±r, baƒülanamadƒ±ƒüƒ±nda fallback kullanƒ±r
  window.themeStore = {
    // Ba≈ülangƒ±√ß durumlarƒ± - ThemeManager varsa g√ºncellenecek
    darkMode: localStorage.getItem('vivacrm-theme') === 'dark',
    systemPreference: window.matchMedia('(prefers-color-scheme: dark)').matches,
    
    init() {
      window.vivaLog('Theme store ba≈ülatƒ±lƒ±yor...');
      
      // Merkezi ThemeManager var mƒ± diye kontrol et
      const themeManager = window.VivaCRM && window.VivaCRM.themeManager;
      
      if (themeManager) {
        // ThemeManager ile entegre √ßalƒ±≈ü
        window.vivaLog('ThemeManager bulundu, entegrasyon yapƒ±lƒ±yor');
        
        // Ba≈ülangƒ±√ß deƒüerlerini ThemeManager'dan al
        this.darkMode = themeManager.currentTheme === 'dark';
        this.systemPreference = themeManager.systemPreference;
        
        // ThemeManager deƒüi≈üikliklerini dinle
        themeManager.subscribe((theme) => {
          this.darkMode = theme === 'dark';
          // Alpine.js store g√ºncellendi bilgisini yay (opsiyonel)
          if (window.Alpine && Alpine.store('theme')) {
            Alpine.store('theme').darkMode = this.darkMode;
          }
        });
      } else {
        // ThemeManager yoksa kendi ba≈ülatmamƒ±zƒ± yap
        window.vivaLog('ThemeManager bulunamadƒ±, baƒüƒ±msƒ±z √ßalƒ±≈üma kullanƒ±lƒ±yor', 'warn');
        
        if (localStorage.getItem('vivacrm-theme') === null) {
          this.useSystemPreference();
        } else {
          this.applyTheme(this.darkMode ? 'dark' : 'light');
        }
        
        // Sistem tercihi deƒüi≈üimini izle
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
          if (localStorage.getItem('vivacrm-theme-source') === 'system') {
            this.darkMode = e.matches;
            this.applyTheme(this.darkMode ? 'dark' : 'light');
          }
        });
      }
    },
    
    toggle() {
      window.vivaLog('Tema deƒüi≈ütiriliyor: ' + (this.darkMode ? 'a√ßƒ±k' : 'koyu'));
      
      // Merkezi ThemeManager var mƒ± diye kontrol et
      const themeManager = window.VivaCRM && window.VivaCRM.themeManager;
      
      if (themeManager) {
        // ThemeManager √ºzerinden deƒüi≈ütir
        themeManager.toggleTheme();
        // Not: ThemeManager zaten tetikleyeceƒüi i√ßin subscribe ile this.darkMode g√ºncellenecek
      } else {
        // Kendi ba≈üƒ±mƒ±za deƒüi≈ütirme
        this.darkMode = !this.darkMode;
        localStorage.setItem('vivacrm-theme', this.darkMode ? 'dark' : 'light');
        localStorage.setItem('vivacrm-theme-source', 'manual');
        this.applyTheme(this.darkMode ? 'dark' : 'light');
        
        // Tema deƒüi≈üikliƒüi olayƒ±nƒ± tetikle
        document.dispatchEvent(new CustomEvent('vivacrm:theme-changed', {
          detail: { 
            theme: this.darkMode ? 'dark' : 'light', 
            darkMode: this.darkMode,
            source: 'themeStore'
          }
        }));
      }
    },
    
    useSystemPreference() {
      // Merkezi ThemeManager var mƒ± diye kontrol et
      const themeManager = window.VivaCRM && window.VivaCRM.themeManager;
      
      if (themeManager) {
        // ThemeManager √ºzerinden sistem tercihini kullan
        themeManager.useSystemPreference();
      } else {
        // Kendi ba≈üƒ±mƒ±za sistem tercihini kullan
        this.darkMode = this.systemPreference;
        localStorage.setItem('vivacrm-theme-source', 'system');
        localStorage.setItem('vivacrm-theme', this.darkMode ? 'dark' : 'light');
        this.applyTheme(this.darkMode ? 'dark' : 'light');
      }
    },
    
    applyTheme(theme) {
      // Bu metod yalnƒ±zca ThemeManager olmadƒ±ƒüƒ±nda kullanƒ±lƒ±r
      if (theme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'vivacrmDark');
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.setAttribute('data-theme', 'vivacrm');
        document.documentElement.classList.remove('dark');
      }
    }
  };

  // Notification bile≈üeni 
  window.notificationComponent = function() {
    return {
      notificationOpen: false,
      
      toggle() {
        this.notificationOpen = !this.notificationOpen;
      },
      
      close() {
        this.notificationOpen = false;
      }
    };
  };

  // Format yardƒ±mcƒ±larƒ±
  window.formatNumber = function(number, decimals = 0) {
    if (number === null || number === undefined) return '';
    
    return new Intl.NumberFormat('tr-TR', {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals
    }).format(number);
  };
  
  window.formatCurrency = function(amount) {
    if (amount === null || amount === undefined) return '';
    
    return new Intl.NumberFormat('tr-TR', {
      style: 'currency',
      currency: 'TRY',
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).format(amount);
  };
  
  window.formatDate = function(date, format = 'short') {
    if (!date) return '';
    
    try {
      const options = {
        short: { day: '2-digit', month: '2-digit', year: 'numeric' },
        medium: { day: '2-digit', month: 'short', year: 'numeric' },
        long: { day: '2-digit', month: 'long', year: 'numeric' }
      };
      
      return new Date(date).toLocaleDateString('tr-TR', options[format] || options.short);
    } catch (e) {
      return date;
    }
  };
  
  window.formatPercent = function(value, decimals = 1) {
    if (value === null || value === undefined) return '';
    
    const numericValue = typeof value === 'string'
      ? parseFloat(value.replace(',', '.'))
      : value;
      
    if (isNaN(numericValue)) return '';
    
    return new Intl.NumberFormat('tr-TR', {
      style: 'percent',
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals
    }).format(numericValue / 100);
  };

  // Sayfa y√ºklendiƒüinde theme store'u ba≈ülat
  document.addEventListener('DOMContentLoaded', function() {
    // Tema deƒüi≈üikliƒüini uygula
    window.themeStore.init();
    
    // Alpine.js y√ºkl√º m√º kontrol et
    if (window.Alpine) {
      // Alpine ile tanƒ±mla
      Alpine.store('theme', window.themeStore);
      Alpine.data('notificationComponent', window.notificationComponent);
      
      // Format fonksiyonlarƒ±nƒ± Alpine.js magic helper olarak kaydet
      if (typeof Alpine.magic === 'function') {
        Alpine.magic('formatNumber', () => window.formatNumber);
        Alpine.magic('formatCurrency', () => window.formatCurrency);
        Alpine.magic('formatDate', () => window.formatDate);
        Alpine.magic('formatPercent', () => window.formatPercent);
      }
      
      window.vivaLog('Global bile≈üenler Alpine.js\'e kaydedildi');
    } else {
      window.vivaLog('Alpine.js y√ºkl√º deƒüil, global bile≈üenler yalnƒ±zca window √ºzerinde tanƒ±mlandƒ±', 'warn');
    }
  });

  // Dashboard bile≈üenlerini de global olarak tanƒ±mla (dashboard sayfalarƒ±nda kullanƒ±labilir)
  window.dashboardComponent = function() {
    return {
      // Durum deƒüi≈ükenleri
      loading: false,
      currentPeriod: 'month',
      customStartDate: null,
      customEndDate: null,
      charts: {},
      
      // Ya≈üam d√∂ng√ºs√º metotlarƒ±
      initialize() {
        // Sunucudan g√∂nderilen ba≈ülangƒ±√ß verilerini kullan
        const initData = window.dashboardInitData || {
          currentPeriod: 'month',
          customStartDate: null,
          customEndDate: null
        };
        
        this.currentPeriod = initData.currentPeriod || 'month';
        this.customStartDate = initData.customStartDate || null;
        this.customEndDate = initData.customEndDate || null;
        
        // HTMX olaylarƒ±nƒ± dinle
        this.setupEventListeners();
        
        // Grafikleri y√ºkle (DOM hazƒ±r olduƒüunda)
        this.$nextTick(() => {
          this.initializeCharts();
        });
      },
      
      /**
       * Olay dinleyicilerini ayarla
       */
      setupEventListeners() {
        // HTMX olaylarƒ±nƒ± dinle
        document.body.addEventListener('htmx:afterSwap', (event) => {
          if (event.detail.target.id === 'dashboard-content') {
            this.loading = false;
            this.initializeCharts();
          }
        });
        
        document.body.addEventListener('htmx:beforeRequest', (event) => {
          if (event.detail.target.id === 'dashboard-content') {
            this.loading = true;
          }
        });
        
        // Tema deƒüi≈üikliƒüi olayƒ±nƒ± dinle
        document.addEventListener('vivacrm:theme-changed', () => {
          this.updateChartsTheme();
        });
      },
      
      /**
       * Se√ßilen d√∂nemi deƒüi≈ütir ve verileri yenile
       */
      setPeriod(period) {
        this.currentPeriod = period;
        this.refreshData();
      },
      
      /**
       * Dashboard verilerini yenile
       */
      refreshData() {
        this.loading = true;
        
        // HTMX ile dashboard i√ßeriƒüini g√ºncelle
        const dashboardContent = document.getElementById('dashboard-content');
        if (dashboardContent && window.htmx) {
          const periodParams = {
            period: this.currentPeriod
          };
          
          // √ñzel tarih aralƒ±ƒüƒ± i√ßin parametreler ekle
          if (this.currentPeriod === 'custom' && this.customStartDate && this.customEndDate) {
            periodParams.start_date = this.customStartDate;
            periodParams.end_date = this.customEndDate;
          }
          
          // HTMX values deƒüerini g√ºncelle ve tetikle
          window.htmx.trigger(dashboardContent, 'periodChanged', {
            params: periodParams
          });
        }
      },
      
      /**
       * Grafikleri ba≈ülat
       */
      initializeCharts() {
        if (typeof ApexCharts === 'undefined') {
          console.log('ApexCharts y√ºkl√º deƒüil, grafikler ba≈ülatƒ±lamadƒ±');
          return;
        }
        
        // Temel uygulama - yalnƒ±zca √∂rnek ama√ßlƒ±
        console.log('Grafikler ba≈ülatƒ±lƒ±yor...');
        
        // Tema deƒüi≈üikliklerini uygula
        this.updateChartsTheme();
      },
      
      /**
       * Grafik temalarƒ±nƒ± g√ºncelle
       */
      updateChartsTheme() {
        // Merkezi ThemeManager var mƒ± diye kontrol et
        const themeManager = window.VivaCRM && window.VivaCRM.themeManager;
        const isDarkMode = themeManager ? 
          themeManager.currentTheme === 'dark' : 
          (document.documentElement.classList.contains('dark') || 
           document.documentElement.getAttribute('data-theme') === 'dark' ||
           document.documentElement.getAttribute('data-theme') === 'vivacrmDark');
        
        Object.values(this.charts).forEach((chart) => {
          if (chart && typeof chart.updateOptions === 'function') {
            chart.updateOptions({
              theme: {
                mode: isDarkMode ? 'dark' : 'light'
              }
            });
          }
        });
      },
      
      /**
       * Tarih formatla
       */
      formatDate(date) {
        return window.formatDate(date);
      },
      
      /**
       * Para birimi formatla
       */
      formatCurrency(amount) {
        return window.formatCurrency(amount);
      },
      
      /**
       * Sayƒ± formatla
       */
      formatNumber(number) {
        return window.formatNumber(number);
      }
    };
  };
  
  // Tarih filtresi bile≈üeni
  window.dateFilterComponent = function() {
    return {
      showDatePicker: false,
      startDate: null,
      endDate: null,
      
      init() {
        if (this.$root.customStartDate) {
          this.startDate = this.$root.customStartDate;
        }
        
        if (this.$root.customEndDate) {
          this.endDate = this.$root.customEndDate;
        }
      },
      
      toggleDatePicker() {
        this.showDatePicker = !this.showDatePicker;
      }
    };
  };
})();